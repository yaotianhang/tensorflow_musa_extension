#!/bin/bash
# Pre-commit hook for code quality checks (open source friendly)
# Runs clang-format and other pre-commit checks with helpful guidance

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "ðŸ§¹ Running pre-commit checks..."

# Check if pre-commit is available
if command -v pre-commit &> /dev/null; then
    echo "Using pre-commit framework..."
    # Run pre-commit but don't fail on warnings, only on errors
    if pre-commit run --hook-stage commit --show-diff-on-failure; then
        echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Some pre-commit checks had issues${NC}"
        echo -e "${YELLOW}ðŸ’¡ These issues have been automatically fixed where possible.${NC}"
        echo -e "${YELLOW}ðŸ’¡ Please review the changes and re-add any files that were modified.${NC}"
        echo -e "${GREEN}âœ… Proceeding with commit anyway (open source friendly)${NC}"
    fi
else
    echo "pre-commit not found, running basic checks..."

    # Basic clang-format check for C++ files
    if command -v clang-format &> /dev/null; then
        MODIFIED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cc|cpp|h)$')
        if [ -n "$MODIFIED_FILES" ]; then
            echo "Checking C++ code formatting..."
            clang-format -style=file -i $MODIFIED_FILES
            # Add formatted files back to staging
            git add $MODIFIED_FILES
            echo -e "${GREEN}âœ… C++ code formatting applied${NC}"
            echo -e "${YELLOW}ðŸ’¡ Please review the formatting changes before committing.${NC}"
        fi
    else
        echo -e "${YELLOW}âš ï¸  clang-format not found, skipping code formatting${NC}"
        echo -e "${YELLOW}ðŸ’¡ Consider installing clang-format for consistent code style.${NC}"
    fi

    # Basic large file warning (not blocking)
    LARGE_FILES=$(git diff --cached --name-only --diff-filter=A | xargs ls -l 2>/dev/null | awk '$5 > 10485760 {print $9}') # 10MB limit
    if [ -n "$LARGE_FILES" ]; then
        echo -e "${YELLOW}âš ï¸  Large files detected (>10MB):${NC}"
        echo "$LARGE_FILES"
        echo -e "${YELLOW}ðŸ’¡ Please consider if these files are necessary in the repository${NC}"
        echo -e "${GREEN}âœ… Proceeding with commit anyway${NC}"
    fi
fi

echo -e "${GREEN}âœ… Pre-commit checks completed!${NC}"
exit 0